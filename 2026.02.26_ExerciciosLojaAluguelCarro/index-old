const mysql = require('mysql')
const express = require('express')
const app = express()
const cors = require('cors')
app.use(cors())
app.use(express.json())

app.get('/', function (req, res) {
    // res.setHeader('Access-Control-Allow-Origin', '*')
    res.send ('ZecaInfo')
})

// conexão servidor guto
// Read All - [GET] / produtos

// const conexao = mysql.createConnection({
//     host: '108.179.193.209',
//     user: 'gutoxa27_alunos',
//     password: 'JD_eXLNHp1ZG',
//     database: 'gutoxa27_bd_loja'
// })
 
// conexão local
// const conexao = mysql.createConnection({
//     host: 'localhost',
//     user: 'root',
//     password: '',
//     database: 'bd_loja'
// })

conexao.connect(function(erro){
    if(erro){
        console.log("deu ruim na conexão \n");
        throw erro;
    }else{
        console.log("Conexão deu bom \n")
    }
})

app.get("/produtos", function (req, res){
    // res.setHeader('Access-Control-Allow-Origin', '*')
    // res.send(lista_produtos)
    conexao.query("SELECT * FROM produtos", function (erro, lista_produtos, campos){
        // console.log(erro)
        // console.log(lista_produtos);
        res.send(lista_produtos)
    })
})


app.get("/unidades", function (req, res){
    // res.setHeader('Access-Control-Allow-Origin', '*')
    conexao.query("SELECT * FROM unidades", 
        function (erro, unidade, campos){
        // console.log(erro)
        // console.log(unidade);
        res.send(unidade)
    })
})

//Read by categoria - [GET]/produtos/:categoria
app.get("/produtos/:categoria", function (req, res){
    // res.setHeader('Access-Control-Allow-Origin', '*')
    //pegamos a categoria que foi enviada na requisição
    const categoria = req.params.categoria
    conexao.query(`SELECT * FROM produtos where categoria='${categoria}'`, 
        function(erro, dados, campos){
            res.send(dados)
    })
})

app.get("/produtos/:categoria/:preco", function (req, res){
    // res.setHeader('Access-Control-Allow-Origin', '*')
    const categoria = req.params.categoria
    const preco = req.params.preco
    conexao.query(`SELECT * FROM produtos where categoria='${categoria}' ORDER BY ${preco}`,
        function(erro, dados, campo){
            res.send(dados)
        }
    )
})

app.get("/produtos/:categoria/:titulo", function (req, res){
    // res.setHeader('Access-Control-Allow-Origin', '*')
    const categoria = req.params.categoria
    const titulo = req.params.titulo
    conexao.query(`SELECT * FROM produtos where categoria='${categoria}' ORDER BY ${titulo}`,
        function(erro, dados, campo){
            res.send(dados)
        }
    )
})

//Enviar para cadastrar produto.
app.post("/produto/", function (req, res){
    const {titulo, preco, descricao, avaliacao, foto, categoria} = req.body;
    conexao.query(`
        INSERT INTO produtos(titulo, foto, descricao, preco, avaliacao, categoria)
        values('${titulo}', '${foto}', '${descricao}', '${preco}', '${avaliacao}', '${categoria}')`,
        function (erro, resultado){
            if (erro) {
                res.json(erro);
            }
            res.send(resultado.insertId);
        });
})

//Enviar cadastro de Unidades
app.post("/unidades/", function (req, res){
    console.dir(req.body)    
    const {nome_da_loja, telefone, email, endereco, latitude, longitude, foto} = req.body;
    conexao.query(`
        INSERT INTO unidades(nome_da_loja, telefone, email, endereco, latitude, longitude, foto)
        values('${nome_da_loja}', '${telefone}', '${email}', '${endereco}', '${latitude}', '${longitude}', '${foto}')`,
        function (erro, resultado){
            if(erro) {
                res.json(erro);
            }
            res.send(resultado.insertId);
        });
})

//Ver produto READ ONE [GET] / produto
app.get("/produto/:id", function (req,res){
    const id = req.params.id
    conexao.query("SELECT * FROM produtos where id = ? ", [id],
    function(erro, dados, campos){
        res.json(dados)
    })
})



app.listen (3000)

